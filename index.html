<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Nomination Form — Web Filler</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --accent:#007aff; --muted:#666; --line:#e9e9ee;
  }
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;margin:18px;background:var(--bg);color:#111}
  main{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
  h1{margin:15px 0 35px 0;font-size:1.50rem}
  .section{background:#fbfbfd;border:1px solid #eee;padding:14px;border-radius:10px;margin:12px 0}
  .section h2{margin:0 0 10px 0;font-size:1.05rem}
  label{display:block;margin:8px 0;font-size:0.95rem}
  input[type=text],input[type=email],input[type=number],input[type=tel],select,textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-top:6px;font-size:1rem;background:#fff
  }
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .muted{color:var(--muted);font-size:0.85rem}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.secondary{background:#999}
  button.ghost{background:transparent;border:1px solid var(--line);color:#333}
  .actions{display:flex;gap:12px;align-items:center}

  /* Header tidy alignment */
  .header-agree{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;
  }
  .header-agree input[type=checkbox]{margin:0}
  .header-agree .title{font-weight:600}
  .header-grid{
    margin-top:10px;
    display:grid;gap:10px;
    grid-template-columns: 1fr 1fr;
    align-items:start;
  }
  .header-item{
    background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px
  }
  .header-item .stack{display:flex;flex-direction:column;gap:6px;width:100%}
  .header-item .inline{display:flex;align-items:center;gap:8px}
  .header-item input[type=checkbox]{margin:0}
  .amount-wrap{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  .amount-wrap label{margin:0}

  .onetime-charge-options {
    grid-column: 2 / -1;
    opacity: 0.5;
    pointer-events: none;
  }
  .onetime-charge-options.active {
    opacity: 1;
    pointer-events: auto;
  }
  .onetime-charge-options fieldset{
    border: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 12px;
  }
  .onetime-charge-options input[type="number"]{ width: auto; margin-top: 0; }
  .onetime-charge-options input[type="number"][disabled] { background-color: #f6f7f9; cursor: not-allowed; }
  .onetime-charge-options .row{ align-items: center; }
  .onetime-charge-options .row:has(#Onetimecharge_alloutstanding:not(:checked)) .option-label { color: var(--muted); }
  .onetime-charge-options .row:has(#Onetimecharge_specific:not(:checked)) .option-label { color: var(--muted); }
  .onetime-charge-options .row:has(#Onetimecharge_specific:not(:checked)) #Onetimecharge_amt { opacity: 0.5; }

  /* Card number */
  .card-number-block .card-number-inputs{display:flex;gap:8px;margin-top:8px}
  .card-digit{width:80px;padding:8px;border-radius:10px;border:1px solid #ddd;text-align:center;font-size:1.05rem;background:#fff}
  .card-digit:focus{outline:2px solid rgba(0,122,255,0.15)}

  /* Policy grid */
  .policy-grid{display:grid;grid-template-columns:1fr;gap:12px}
  .policy{background:#fff;padding:12px;border-radius:10px;border:1px solid #eee;position:relative}
  .policy h3{margin:0 0 8px 0;font-size:0.95rem;display:flex;align-items:center;justify-content:space-between}
  .policy .remove-btn{background:transparent;border:1px solid var(--line);color:#333;border-radius:8px;padding:6px 10px;font-size:0.9rem}
  .policy .remove-btn:hover{border-color:#d0d0d7}

  /* Signature preview tiles */
  .sig-preview{
    width:100%; height:150px; border:1px dashed #bbb; border-radius:10px;
    display:flex; align-items:center; justify-content:center; background:#fff; cursor:pointer; position:relative;
  }
  .sig-preview img{ max-width:100%; max-height:100%; object-fit:contain; }
  .sig-preview span{ color:#999; }

  /* Signature Modal */
  .sig-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; }
  .sig-modal .box{
    width:min(560px, 92vw); background:#fff; margin:6vh auto; padding:14px; border-radius:12px;
    box-shadow:0 18px 50px rgba(0,0,0,.25)
  }
  .sig-modal h3{ margin:0 0 8px 0; }
  /* NOTE: canvas is responsive via CSS; internal pixels are set in JS for crispness */
  #sigCanvas{ width:100%; height:220px; background:#fff; border:1px solid #ddd; border-radius:10px; touch-action:none }
  .sig-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }

    /* XY% signature tuning  */
   .hidden-inputs {display: none;}

  
  /* Save indicator */
  #saveStatus{
    position:fixed; bottom:12px; right:12px; background:var(--accent); color:#fff;
    padding:6px 10px; border-radius:8px; font-size:0.85rem; opacity:0; transition:opacity .25s;
  }

  @media (max-width:900px){ .header-grid{grid-template-columns:1fr} .onetime-charge-options{grid-column: 1 / -1;} }
  @media (max-width:720px){ .policy-grid{grid-template-columns:1fr} .card-digit{width:60px} }
</style>
</head>
<body>
<main>
  <h1>Nomination Form(LF4054)</h1>

<section class="section" id="sectionA">
    <h2>Section A - Policy Details</h2>

    <div class="row">
    <label>Policy No.
      <input id="Nom_PolicyNumber" type="text" placeholder="Enter Policy No.">
    </label>

    <label>Proposed Life Insured / Insured
      <input id="Nom_InsuredName" type="text" placeholder="Enter Name">
    </label>
    </div>

 
      <label>Marital Status</label>
      <div class="row">
      <label class="inline"><input name="MaritalStatus" id="Nom_MaritalStatus_Single" type="radio">Single</label>
      <label class="inline"><input name="MaritalStatus" id="Nom_MaritalStatus_Married" type="radio">Married</label>
      <label class="inline"><input name="MaritalStatus" id="Nom_MaritalStatus_Widowed" type="radio">Widowed</label>
      <label class="inline"><input name="MaritalStatus" id="Nom_MaritalStatus_Divorced" type="radio">Divorced</label>
    </div>

      <label style="flex:1">Religion</label>
      <div class="row">
      <label class="inline"><input name="Religion" id="Nom_Religion_Muslim" type="radio">Muslim</label>
      <label class="inline"><input name="Religion" id="Nom_Religion_NonMuslim" type="radio">Non-Muslim</label>
    </div>
  </section>

  <section class="section" id="sectionA">
    <h2>Section B — Nominee Entries</h2>
    <div id="nomineesContainer" class="policy-grid"></div>
    <div class="row">
      <button id="addNominee">+ Add Another Nominee</button>
      <small class="muted">Up to 5 Nominees</small>
    </div>
  </section>

  <section class="section">
    <h2>Section B - Card Details</h2>

    <label>Cardholder's Name (as in I/C)
      <input id="CardName" type="text" placeholder="AS IN I/C">
    </label>

    <div class="row">
      <label class="inline"><input name="cardType" id="CC_Tick" type="radio"> Credit Card</label>
      <label class="inline"><input name="cardType" id="DebitC_Tick" type="radio"> Debit Card</label>
    </div>

    <div class="card-number-block">
      <label>Card Number</label>
      <div class="card-number-inputs">
        <input class="card-digit" id="CardNo_1" maxlength="4" inputmode="numeric" pattern="\d*">
        <input class="card-digit" id="CardNo_2" maxlength="4" inputmode="numeric" pattern="\d*">
        <input class="card-digit" id="CardNo_3" maxlength="4" inputmode="numeric" pattern="\d*">
        <input class="card-digit" id="CardNo_4" maxlength="4" inputmode="numeric" pattern="\d*">
      </div>
      <small class="muted">Type 4 digits per box. Paste full 16-digit number — it will auto-split.</small>
    </div>

    <div class="row">
      <label style="flex:1">Expiry (Month)
        <select id="CardExpry_M_Select">
          <option value="">-- Month --</option>
        </select>
      </label>
      <label style="flex:1">Expiry (Year)
        <select id="CardExpry_Y_Select">
          <option value="">-- Year --</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label style="flex:1">Issuing Bank
        <select id="CardBank_Select">
          <option value="">-- Select Bank --</option>
        </select>
        </label>
    </div>

    <div class="row">
      <label class="inline"><input name="brand" id="Visa_Tick" type="radio"> Visa</label>
      <label class="inline"><input name="brand" id="Master_Tick" type="radio"> Master</label>
    </div>
  </section>

<section class="section" id="sectionC">
  <h2>Section C - Third Party / Source</h2>

  <label class="inline">
    <input id="ThirdPP_Yes" type="checkbox">
    <span>Payment by Third Party Payor (other than Policyowner)</span>
  </label>

  <div id="thirdPP_ic_wrap" style="display:none; margin-top:8px;">
    <label class="inline">
      <input id="ThirdPP_SubmittedNRIC" type="checkbox">
      <span>Prepare IC Copy to be submitted together with this form</span>
    </label>
  </div>

  <div id="thirdPP_fields" style="display:none; margin-top:14px;">
    <label>Third Party Payor’s Name
      <input id="ThirdPP_Name" type="text">
    </label>

    <label>Date of Birth</label>
    <div class="row">
      <select id="ThirdPP_DOB_DD"></select>
      <select id="ThirdPP_DOB_MM"></select>
      <input id="ThirdPP_DOB_YYYY" type="number" min="1900" max="2100" placeholder="YYYY">
    </div>

    <label>IC No.
      <input id="ThirdPP_NIRC" type="text">
    </label>
    <label>Nationality
      <input id="ThirdPP_Nationality" type="text">
    </label>
    <label>Correspondence Address Line 1
      <input id="ThirdPP_CorrespAdd_Line1" type="text">
    </label>
    <label>Correspondence Address Line 2
      <input id="ThirdPP_CorrespAdd_Line2" type="text">
    </label>
    <label>Postcode
      <input id="ThirdPP_CorrrepAdd_Postcode" type="number">
    </label>
    <label>Country
      <input id="ThirdPP_CorrespAdd_Country" type="text">
    </label>
    <label>Email Address
      <input id="ThirdPP_Email" type="email">
    </label>
    <label>Mobile No.
      <input id="ThirdPP_Phone" type="text">
    </label>
    <label>Occupation
      <input id="ThirdPP_Occupation" type="text">
    </label>
    <label>Name of Employer
      <input id="ThirdPP_Employer" type="text">
    </label>
    <label>Nature of Business
      <input id="ThirdPP_NatureBusiness" type="text">
    </label>
    <label>Monthly Income (RM)
      <input id="ThirdPP_Income" type="number" step="0.01">
    </label>

    <h3>Source of Funds</h3>
    <label class="inline"><input id="ThirdPP_SourceFund_Self" type="checkbox"> <span>Self</span></label>
    <label class="inline"><input id="ThirdPP_SourceFund_Parent" type="checkbox"> <span>Parent(s)</span></label>
    <label class="inline"><input id="ThirdPP_SourceFund_Spouse" type="checkbox"> <span>Spouse</span></label>
    <label class="inline"><input id="ThirdPP_SourceFund_Others" type="checkbox"> <span>Others</span></label>
    <label>If others specify
      <input id="ThirdPP_SourceFund_Others_Write" type="text">
    </label>

    <h3>Source of Wealth</h3>
    <label class="inline"><input id="ThirdPP_SourceWealth_EmployBus" type="checkbox"> <span>Employment/Business</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Invest" type="checkbox"> <span>Investment</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Inherit" type="checkbox"> <span>Inheritance</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Savings" type="checkbox"> <span>Savings</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Parents" type="checkbox"> <span>Parents</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Spouse" type="checkbox"> <span>Spouse</span></label>
    <label class="inline"><input id="ThirdPP_SourceWealth_Others" type="checkbox"> <span>Others</span></label>
    <label>If others specify
      <input id="ThirdPP_SourceWealth_Others_Write" type="text">
    </label>
  </div>
</section>


<section class="section">
  <h2>Section E — Signature</h2>

  <label>Policy Owner's Name
    <input id="Sign_OwnerName" type="text">
  </label>
  <div class="row" style="margin-top: -10px; margin-bottom: 12px;">
    <label class="inline">
      <input type="checkbox" id="SameAsCardOwner">
      <span>Same as Card owner</span>
    </label>
  </div>

  <div class="row">
    <label style="flex:1">IC No.
      <input id="Sign_OwnerNIRC" type="text">
    </label>
    <label style="flex:1">Signed at (State)
      <select id="Sign_State_Select">
        <option value="">-- Select State --</option>
      </select>
    </label>
  </div>

  <div class="row">
    <label>Signed Date (DD)
      <select id="Sign_Date_Select"></select>
    </label>
    <label>Signed Month
      <select id="Sign_Month_Select"></select>
    </label>
    <label>Signed Year (YYYY)
      <select id="Sign_Year_Select"></select>
    </label>
  </div>

  <!-- Tap-to-sign previews (Owner + Payor) -->
  <h3>Policy Owner Signature</h3>
  <div class="sig-preview" id="preview_owner" onclick="openSig('owner')">
    <span>Tap to Sign (Owner)</span>
  </div>
  <div class="row">
    <button id="clearPreviewOwner" class="secondary" type="button">Clear Signature</button>
  </div>

  <div id="payorSignatureSection" style="display:none; margin-top: 20px;">
    <h3>Fill and Sign only if Payor is not Policy Owner</h3>
    <label>Payor's Name
      <input id="Sign_PayorName" type="text">
    </label>
    <div class="row" style="margin-top: -10px; margin-bottom: 12px;">
      <label class="inline">
        <input type="checkbox" id="SameAsThirdPartyPayorName">
        <span>Same as Third Party Payor</span>
      </label>
    </div>

    <label>Payor's IC No.
      <input id="Sign_PayorNIRC" type="text">
    </label>
    <div class="row" style="margin-top: -10px; margin-bottom: 12px;">
      <label class="inline">
        <input type="checkbox" id="SameAsThirdPartyPayorNIRC">
        <span>Same as Third Party Payor</span>
      </label>
    </div>

    <h3>Payor Signature</h3>
    <div class="sig-preview" id="preview_payor" onclick="openSig('payor')">
      <span>Tap to Sign (Payor)</span>
    </div>
    <div class="row">
      <button id="clearPreviewPayor" class="secondary" type="button">Clear Signature</button>
    </div>
  </div>
</section>

  <section class="section actions">
    <button id="generate">Generate PDF</button>
    <button id="resetAll" class="secondary">Reset All</button>
  </section>

  <div class="hidden-inputs">
  <h3>Owner Signature</h3>
  <label>
    X: <input type="number" id="sigX_owner" value="50" />
  </label>
  <label>
    Y: <input type="number" id="sigY_owner" value="490" />
  </label>
  <label>
    Scale (%): <input type="number" id="sigScale_owner" value="45" />
  </label>
</div>

<div class="hidden-inputs">
  <h3>Payor Signature</h3>
  <label>
    X: <input type="number" id="sigX_payor" value="370" />
  </label>
  <label>
    Y: <input type="number" id="sigY_payor" value="490" />
  </label>
  <label>
    Scale (%): <input type="number" id="sigScale_payor" value="40" />
  </label>
</div>

  <footer>
    <small>Make sure <code>Credit Card Enrolment Form_LF4092_200524_fillable.pdf</code> is in the same folder.</small>
  </footer>
</main>

<!-- Signature Modal -->
<div id="sigModal" class="sig-modal" aria-hidden="true">
  <div class="box">
    <h3 id="sigModalTitle">Draw Signature</h3>
    <!-- Responsive canvas: internal pixels are set in JS for crispness -->
    <canvas id="sigCanvas"></canvas>
    <div class="sig-actions">
      <button id="sigDone" type="button">Done</button>
      <button id="sigClear" type="button" class="ghost">Clear</button>
      <button id="sigCancel" type="button" class="secondary">Cancel</button>
    </div>
  </div>
</div>

<div id="saveStatus">Saved</div>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script>
/* ---------- CONFIG ---------- */
const PDF_FILENAME = "Nomination and Trustees_LF4056_LF4054_fillable.pdf";
const MAX_NOMINEES = 5;

/* ---------- helpers ---------- */
function $(id){return document.getElementById(id);}
function safeSetText(form, name, text){
  try{ form.getTextField(name).setText(String(text || "")); } catch(e){ /* missing field ok */ }
}
function safeCheck(form, name, checked){
  try{ const cb = form.getCheckBox(name); if (checked) cb.check(); else cb.uncheck(); } catch(e){ /* missing field ok */ }
}

/* ---------- Save indicator ---------- */
const saveStatusEl = $("saveStatus");
function showSaveStatus(){
  saveStatusEl.style.opacity = 1;
  clearTimeout(saveStatusEl._timer);
  saveStatusEl._timer = setTimeout(()=> saveStatusEl.style.opacity = 0, 1200);
}
function saveElValue(el){
  if(!el || !el.id) return;
  if(el.type === 'checkbox' || el.type === 'radio'){
    localStorage.setItem(el.id, el.checked);
  } else {
    localStorage.setItem(el.id, el.value);
  }
  showSaveStatus();
}
function autoBindSave(el){
  const saved = localStorage.getItem(el.id);
  if(saved !== null){
    if(el.type === 'checkbox' || el.type === 'radio') el.checked = (saved === 'true');
    else el.value = saved;
  }
  el.addEventListener((el.type === 'checkbox' || el.type === 'radio') ? 'change' : 'input', ()=> saveElValue(el));
}

/* ---------- HEADER logic (revised for radio buttons) ---------- */
const oneTimeChk = $("Onetimecharge_tick");
const oneTimeOptions = document.querySelector('.onetime-charge-options');
const allOutstandingRadio = $("Onetimecharge_alloutstanding");
const specificAmountRadio = $("Onetimecharge_specific");
const oneTimeAmt = $("Onetimecharge_amt");

function updateOneTimeUI(){
  if (oneTimeChk.checked){
    oneTimeOptions.classList.add('active');
    allOutstandingRadio.disabled = false;
    specificAmountRadio.disabled = false;
    oneTimeAmt.disabled = !specificAmountRadio.checked;
  } else {
    oneTimeOptions.classList.remove('active');
    allOutstandingRadio.disabled = true;
    specificAmountRadio.disabled = true;
    oneTimeAmt.disabled = true;
    allOutstandingRadio.checked = false;
    specificAmountRadio.checked = false;
    oneTimeAmt.value = "";
    localStorage.removeItem("onetime_charge_option");
    localStorage.removeItem("Onetimecharge_amt");
  }
}
["CCAgree","Onetimecharge_tick"].forEach(id=>{ const el = $(id); if(el) autoBindSave(el); });
oneTimeChk.addEventListener('change', ()=>{
  updateOneTimeUI(); saveElValue(oneTimeChk);
});
[allOutstandingRadio, specificAmountRadio].forEach(radio => {
  radio.addEventListener('change', () => {
    oneTimeAmt.disabled = !specificAmountRadio.checked;
    if (allOutstandingRadio.checked) {
      oneTimeAmt.value = "";
      localStorage.removeItem("Onetimecharge_amt");
    }
    localStorage.setItem("onetime_charge_option", radio.value);
    showSaveStatus();
  });
});
oneTimeAmt.addEventListener('input', ()=>{ saveElValue(oneTimeAmt); });
function restoreOneTimeState(){
  const isOneTimeChecked = localStorage.getItem("Onetimecharge_tick") === 'true';
  const savedOption = localStorage.getItem("onetime_charge_option");
  const savedAmount = localStorage.getItem("Onetimecharge_amt");
  oneTimeChk.checked = isOneTimeChecked;
  if (isOneTimeChecked) {
    if (savedOption === 'all') { allOutstandingRadio.checked = true; }
    else if (savedOption === 'specific') { specificAmountRadio.checked = true; oneTimeAmt.value = savedAmount || ""; }
  }
  updateOneTimeUI();
}

/* ---------- SECTION A: Dynamic policies ---------- */
const nomineesContainer = $("nomineesContainer");
const addNomineeBtn = $("addNominee");
let nomineeCount = 0;

function relationshipOptionsHTML(selected=""){
  const opts = ["SPOUSE","SON","DAUGHTER","PARENT","GRANDPARENT","SIBLING","FRIEND"];
  return opts.map(v=> `<option value="${v}" ${v===selected?"selected":""}>${v}</option>`).join("");
}

function dayOptionsHTML(selected=""){
  return Array.from({length:31}, (_,i)=> {
    const v = String(i+1).padStart(2,"0");
    return `<option value="${v}" ${v===selected?"selected":""}>${v}</option>`;
  }).join("");
}
function monthOptionsHTML(selected=""){
  return Array.from({length:12}, (_,i)=> {
    const v = String(i+1).padStart(2,"0");
    return `<option value="${v}" ${v===selected?"selected":""}>${v}</option>`;
  }).join("");
}
  
// ---- CREATE ENTRY ----
function createNomineeEntry(index){
  const wrap = document.createElement("div");
  wrap.className = "nominee";
  wrap.dataset.index = index;
  wrap.innerHTML = `
    <h3><span>Nominee Entry ${index}</span>
      <button type="button" class="remove-btn">Remove</button>
    </h3>
    <label>Nominee Name
      <input type="text" id="Nom_Nominee${index}_Name">
    </label>
    <label>Date of Birth (Day)
      <select id="Nom_Nominee${index}_DD"><option value="">DD</option>${dayOptionsHTML()}</select>
    </label>
    <label>Date of Birth (Month)
      <select id="Nom_Nominee${index}_MM"><option value="">MM</option>${monthOptionsHTML()}</select>
    </label>
    <label>Birthday (Year)
      <input type="text" id="Nom_Nominee${index}_YYYY" placeholder="YYYY" maxlength="4">
    </label>
    <label>NRIC/Passport No.
      <input type="text" id="Nom_Nominee${index}_NRICPassport">
    </label>
    <label>Email
      <input type="text" id="Nom_Nominee${index}_Email">
    </label>
    <label>Mobile No.
      <input type="text" id="Nom_Nominee${index}_Mobile">
    </label>
    <label>Nationality
      <input type="text" id="Nom_Nominee${index}_Nationality">
    </label>
    <label>Relationship to Proposed Life Insured/Insured
      <select id="Nom_Nominee${index}_Relationship"><option value="">-- CHOOSE --</option>${relationshipOptionsHTML()}</select>
    </label>
    <label>Percentage of Share (%)
      <input type="number" id="Nom_Nominee${index}_Share">
    </label>

    <!-- UI CONDITION 1: Correspondence Address -->
    <label>
      <input type="checkbox" id="Nom_Nominee${index}_HasCorres"> Correspondence Address (if different from Proposed Life Insured/Insured)
    </label>
    <div class="corres-section" id="Nom_Nominee${index}_CorresWrap" style="display:none">
      <label>Correspondence Address Line 1
        <input type="text" id="Nom_Nominee${index}_CorresAdd_Line1">
      </label>
      <label>Correspondence Address Line 2
        <input type="text" id="Nom_Nominee${index}_CorresAdd_Line2">
      </label>
      <label>Postcode
        <input type="text" id="Nom_Nominee${index}_CorresAdd_Postcode">
      </label>
      <label>Country
        <input type="text" id="Nom_Nominee${index}_CorresAdd_Country">
      </label>

      <!-- UI CONDITION 2: Residential Address -->
      <label>
        <input type="checkbox" id="Nom_Nominee${index}_HasRes"> Residential Address (if different from Correspondence Address)
      </label>
      <div class="res-section" id="Nom_Nominee${index}_ResWrap" style="display:none">
        <label>Residential Address Line 1
          <input type="text" id="Nom_Nominee${index}_ResAdd_Line1">
        </label>
        <label>Residential Address Line 2
          <input type="text" id="Nom_Nominee${index}_ResAdd_Line2">
        </label>
        <label>Postcode
          <input type="text" id="Nom_Nominee${index}_ResAdd_Postcode">
        </label>
        <label>Country
          <input type="text" id="Nom_Nominee${index}_ResAdd_Country">
        </label>
      </div>
    </div>
  `;

  // Auto uppercase for all text inputs
  wrap.querySelectorAll("input[type=text]").forEach(el=>{
    el.addEventListener("input", ()=>{ el.value = el.value.toUpperCase(); saveElValue(el); });
  });

  // Bind all inputs/selects to save
  wrap.querySelectorAll("input, select").forEach(el=>{
    autoBindSave(el);
    const saved = localStorage.getItem(el.id);
    if(saved!==null){
      if(el.type==="checkbox") el.checked = saved==="true";
      else el.value = saved;
    }
  });

  // UI condition toggle
  const hasCorres = wrap.querySelector("#Nom_Nominee"+index+"_HasCorres");
  const corresWrap = wrap.querySelector("#Nom_Nominee"+index+"_CorresWrap");
  const hasRes = wrap.querySelector("#Nom_Nominee"+index+"_HasRes");
  const resWrap = wrap.querySelector("#Nom_Nominee"+index+"_ResWrap");

  function updateVisibility(){
    corresWrap.style.display = hasCorres.checked ? "block" : "none";
    resWrap.style.display = (hasCorres.checked && hasRes.checked) ? "block" : "none";
    saveElValue(hasCorres);
    saveElValue(hasRes);
  }
  hasCorres.addEventListener("change", updateVisibility);
  hasRes.addEventListener("change", updateVisibility);

  // Restore visibility from saved state
  updateVisibility();

  // Remove button
  wrap.querySelector(".remove-btn").addEventListener("click", ()=>{
    nomineesContainer.removeChild(wrap);
    nomineeCount = Math.max(0, nomineeCount - 1);
    addNomineeBtn.disabled = nomineeCount >= MAX_NOMINEES;
    renumberNominees();
    showSaveStatus();
  });

  return wrap;
}

// ---- ADD ----
function addNominee(){
  if(nomineeCount >= MAX_NOMINEES) return;
  nomineeCount++;
  const node = createNomineeEntry(nomineeCount);
  nomineesContainer.appendChild(node);
  addNomineeBtn.disabled = nomineeCount >= MAX_NOMINEES;
  localStorage.setItem("nomineeCount", nomineeCount);
  showSaveStatus();
}

// ---- RENUMBER ----
function renumberNominees(){
  const cards = Array.from(nomineesContainer.querySelectorAll(".nominee"));
  nomineeCount = cards.length;
  localStorage.setItem("nomineeCount", nomineeCount);
}

// ---- INIT ----
addNomineeBtn.addEventListener("click", addNominee);

// Utils
function autoBindSave(el){ el.addEventListener("input", ()=> saveElValue(el)); }
function saveElValue(el){ 
  if(el.type==="checkbox") localStorage.setItem(el.id, el.checked);
  else localStorage.setItem(el.id, el.value);
}
function showSaveStatus(){ console.log("saved"); }

// Restore saved nominees
for(let i=1;i<=nomineeCount;i++){
  nomineesContainer.appendChild(createNomineeEntry(i));
}
addNomineeBtn.disabled = nomineeCount >= MAX_NOMINEES;

/* ---------- CARD details enhancements ---------- */
$("CardName").addEventListener("input", (e)=>{ e.target.value = e.target.value.toUpperCase(); saveElValue(e.target); });
const cardDigits = [ $("CardNo_1"), $("CardNo_2"), $("CardNo_3"), $("CardNo_4") ];
cardDigits.forEach((el, idx)=>{
  autoBindSave(el);
  el.addEventListener("input", ()=>{
    el.value = el.value.replace(/\D/g,'').slice(0,4);
    saveElValue(el);
    if(el.value.length===4 && idx<cardDigits.length-1) cardDigits[idx+1].focus();
  });
  el.addEventListener("keydown", (e)=>{ if(e.key==="Backspace" && el.value.length===0 && idx>0) cardDigits[idx-1].focus(); });
  el.addEventListener("paste", (e)=>{
    e.preventDefault();
    const paste = (e.clipboardData || window.clipboardData).getData('text');
    const digits = paste.replace(/\D/g,'').slice(0,16).padEnd(16,' ');
    for(let i=0;i<4;i++){ cardDigits[i].value = digits.slice(i*4, i*4+4).trim(); saveElValue(cardDigits[i]); }
    for(let i=0;i<4;i++){ if(cardDigits[i].value.length<4){ cardDigits[i].focus(); break; } if(i===3) cardDigits[3].focus(); }
  });
});
(function populateExpirySelectors(){
  const mmSel = $("CardExpry_M_Select");
  const months = [
    "01 - JANUARY","02 - FEBRUARY","03 - MARCH","04 - APRIL",
    "05 - MAY","06 - JUNE","07 - JULY","08 - AUGUST",
    "09 - SEPTEMBER","10 - OCTOBER","11 - NOVEMBER","12 - DECEMBER"
  ];
  months.forEach(m=>{
    const opt=document.createElement("option");
    opt.value = m.slice(0,2);
    opt.textContent = m;
    mmSel.appendChild(opt);
  });
  autoBindSave(mmSel);
  const yySel = $("CardExpry_Y_Select");
  const currentYear = new Date().getFullYear();
  for(let y=currentYear; y<=currentYear+15; y++){
    const opt=document.createElement("option");
    opt.value = String(y).slice(-2);
    opt.textContent = String(y);
    yySel.appendChild(opt);
  }
  autoBindSave(yySel);
})();
(function populateBanks(){
  const banks = [
    "MAYBANK","CIMB BANK","PUBLIC BANK","RHB BANK","HONG LEONG BANK","AMBANK",
    "UOB BANK","OCBC BANK","HSBC BANK","AFFIN BANK","ALLIANCE BANK",
    "BANK ISLAM","BANK MUAMALAT","BANK RAKYAT","BANK SIMPANAN NASIONAL (BSN)",
    "STANDARD CHARTERED BANK","CITIBANK","MUFG BANK","MIZUHO BANK",
    "BANK OF CHINA","BANGKOK BANK BERHAD","BNP PARIBAS MALAYSIA","DEUTSCHE BANK",
    "J.P. MORGAN MALAYSIA","ICBC", "GX BANK"
  ];
  const sel = $("CardBank_Select");
  banks.forEach(b=>{ const o=document.createElement("option"); o.value=b; o.textContent=b; sel.appendChild(o); });
  autoBindSave(sel);
})();

// --- Auto uppercase for signatory Policy Owner and Payor name  ---
document.getElementById("Sign_OwnerName").addEventListener("input", e => {
  e.target.value = e.target.value.toUpperCase();
  saveElValue(e.target);
});
document.getElementById("Sign_PayorName").addEventListener("input", e => {
  e.target.value = e.target.value.toUpperCase();
  saveElValue(e.target);
});


/* Populate DOB dropdowns for Third Party */
(function populateDOB(){
  const daySel = $("ThirdPP_DOB_DD");
  daySel.innerHTML = '<option value="">-- Day --</option>';
  for(let d=1; d<=31; d++){ const val = String(d).padStart(2,'0'); daySel.innerHTML += `<option value="${val}">${val}</option>`; }
  autoBindSave(daySel);
  const monthSel = $("ThirdPP_DOB_MM");
  monthSel.innerHTML = '<option value="">-- Month --</option>';
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  months.forEach((m,i)=>{ const val = String(i+1).padStart(2,'0'); monthSel.innerHTML += `<option value="${val}">${val} - ${m}</option>`; });
  autoBindSave(monthSel);
})();

/* Section C: show/hide + uppercase */
function updateThirdPPUI(){
  $("thirdPP_ic_wrap").style.display = $("ThirdPP_Yes").checked ? "block" : "none";
  $("thirdPP_fields").style.display = ($("ThirdPP_Yes").checked && $("ThirdPP_SubmittedNRIC").checked) ? "block" : "none";
}
document.querySelectorAll("#sectionC input[type=text], #sectionC input[type=tel], #sectionC input[type=number]").forEach(inp=>{
  if (inp.id.toLowerCase().includes("email")) return;
  inp.addEventListener("input", ()=>{ inp.value = inp.value.toUpperCase(); saveElValue(inp); });
});
["ThirdPP_Yes","ThirdPP_SubmittedNRIC"].forEach(id=>{
  const el = $(id);
  autoBindSave(el);
  el.addEventListener("change", ()=>{
    updateThirdPPUI(); saveElValue(el); updatePayorSectionUI();
  });
});
updateThirdPPUI();

/* Section E: Meta fields + states/dates */
const signOwnerName = $("Sign_OwnerName");
const sameAsCardOwner = $("SameAsCardOwner");
const cardName = $("CardName");
sameAsCardOwner.addEventListener("change", () => {
  if (sameAsCardOwner.checked) { signOwnerName.value = cardName.value.toUpperCase(); signOwnerName.disabled = true; }
  else { signOwnerName.value = ""; signOwnerName.disabled = false; }
  saveElValue(signOwnerName);
});
cardName.addEventListener("input", () => {
  if (sameAsCardOwner.checked) { signOwnerName.value = cardName.value.toUpperCase(); saveElValue(signOwnerName); }
});
(function populateStates() {
  const states = ["SELANGOR", "K.LUMPUR", "MELAKA", "N.SEMBILAN", "JOHOR", "PERAK", "KEDAH", "PULAU PINANG", "KELANTAN", "TERENGGANU", "PAHANG", "PERLIS", "SABAH", "SARAWAK"];
  const select = $("Sign_State_Select");
  states.forEach(s => { const o = document.createElement("option"); o.value = s; o.textContent = s; select.appendChild(o); });
  autoBindSave(select);
})();
(function populateSignDate() {
  const dateSelect = $("Sign_Date_Select");
  dateSelect.innerHTML = '<option value="">-- DD --</option>';
  for (let d = 1; d <= 31; d++) { const val = String(d).padStart(2, '0'); dateSelect.innerHTML += `<option value="${val}">${val}</option>`; }
  autoBindSave(dateSelect);
 const monthSelect = $("Sign_Month_Select");
monthSelect.innerHTML = '<option value="">-- MM --</option>';
const months = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"];
months.forEach(m => {
  monthSelect.innerHTML += `<option value="${m.toUpperCase()}">${m.toUpperCase()}</option>`;
});
autoBindSave(monthSelect);
  const yearSelect = $("Sign_Year_Select");
  yearSelect.innerHTML = '<option value="">-- YYYY --</option>';
  for (let y = 2025; y <= 2030; y++) { yearSelect.innerHTML = yearSelect.innerHTML + `<option value="${y}">${y}</option>`; }
  autoBindSave(yearSelect);
})();

/* Payor section visibility + linking */
const payorSection = $("payorSignatureSection");
const thirdPPYes = $("ThirdPP_Yes");
const thirdPPSubmittedNRIC = $("ThirdPP_SubmittedNRIC");
const signPayorName = $("Sign_PayorName");
const sameAsThirdPartyPayorName = $("SameAsThirdPartyPayorName");
const thirdPPName = $("ThirdPP_Name");
const signPayorNIRC = $("Sign_PayorNIRC");
const sameAsThirdPartyPayorNIRC = $("SameAsThirdPartyPayorNIRC");
const thirdPPNIRC = $("ThirdPP_NIRC");
function updatePayorSectionUI() {
  const isPayorVisible = thirdPPYes.checked && thirdPPSubmittedNRIC.checked;
  payorSection.style.display = isPayorVisible ? "block" : "none";
}
thirdPPYes.addEventListener("change", updatePayorSectionUI);
thirdPPSubmittedNRIC.addEventListener("change", updatePayorSectionUI);
sameAsThirdPartyPayorName.addEventListener("change", () => {
  if (sameAsThirdPartyPayorName.checked) { signPayorName.value = thirdPPName.value.toUpperCase(); signPayorName.disabled = true; }
  else { signPayorName.value = ""; signPayorName.disabled = false; }
  saveElValue(signPayorName);
});
sameAsThirdPartyPayorNIRC.addEventListener("change", () => {
  if (sameAsThirdPartyPayorNIRC.checked) { signPayorNIRC.value = thirdPPNIRC.value; signPayorNIRC.disabled = true; }
  else { signPayorNIRC.value = ""; signPayorNIRC.disabled = false; }
  saveElValue(signPayorNIRC);
});
thirdPPName.addEventListener("input", () => {
  if (sameAsThirdPartyPayorName.checked) { signPayorName.value = thirdPPName.value.toUpperCase(); saveElValue(signPayorName); }
});
thirdPPNIRC.addEventListener("input", () => {
  if (sameAsThirdPartyPayorNIRC.checked) { signPayorNIRC.value = thirdPPNIRC.value; saveElValue(signPayorNIRC); }
});
updatePayorSectionUI();

/* ---------- SIGNATURE MODAL LOGIC (Owner + Payor) with HiDPI scaling ---------- */
let sigTarget = null;
const sigModal = $("sigModal");
const sigCanvas = $("sigCanvas");
const sigCtx = sigCanvas.getContext("2d");
let drawing = false;
let scaleX = 1, scaleY = 1;

/* Resize canvas to look crisp on any screen size & DPR */
function resizeSigCanvas(){
  const dpr = window.devicePixelRatio || 1;
  const cssWidth = sigCanvas.clientWidth || sigCanvas.parentElement.clientWidth || 560;
  const cssHeight = sigCanvas.clientHeight || 220;
  sigCanvas.width = Math.max(1, Math.floor(cssWidth * dpr));
  sigCanvas.height = Math.max(1, Math.floor(cssHeight * dpr));
  sigCtx.setTransform(1,0,0,1,0,0); // reset
  sigCtx.scale(dpr, dpr);
  sigCtx.lineWidth = 2;
  sigCtx.lineCap = "round";
  sigCtx.strokeStyle = "#000";
  scaleX = sigCanvas.width / (sigCanvas.getBoundingClientRect().width || cssWidth);
  scaleY = sigCanvas.height / (sigCanvas.getBoundingClientRect().height || cssHeight);
  // White background (prevents transparent PNG on PDFs)
  //sigCtx.fillStyle = "#fff";
  //sigCtx.fillRect(0,0,sigCanvas.width/scaleX, sigCanvas.height/scaleY);
}

function openSig(target){
  sigTarget = target; // 'owner' | 'payor'
  $("sigModalTitle").textContent = target === 'owner' ? "Sign: Policy Owner" : "Sign: Payor";

  sigModal.style.display = "block";
  sigModal.setAttribute("aria-hidden", "false");

  // Next frame: ensure layout settled then resize canvas
  requestAnimationFrame(()=>{
    resizeSigCanvas();
    // If there is an existing signature, draw it to current canvas size
    const existing = localStorage.getItem("sig_"+target);
    if (existing){
      const img = new Image();
      img.onload = ()=>{
        // cover the canvas area with existing image
        sigCtx.drawImage(img, 0, 0, sigCanvas.width/scaleX, sigCanvas.height/scaleY);
      };
      img.src = existing;
    }
  });
}
$("sigClear").addEventListener("click", ()=>{
  sigCtx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
  // Repaint white bg in CSS pixels
  //sigCtx.fillStyle="#fff"; sigCtx.fillRect(0,0,sigCanvas.width/scaleX, sigCanvas.height/scaleY);
});
$("sigCancel").addEventListener("click", closeSigModal);
function closeSigModal(){
  sigModal.style.display = "none";
  sigModal.setAttribute("aria-hidden", "true");
  sigTarget = null;
}
$("sigDone").addEventListener("click", ()=>{
  if(!sigTarget) return;
  const dataURL = sigCanvas.toDataURL("image/png");
  localStorage.setItem("sig_"+sigTarget, dataURL);
  const preview = $("preview_"+sigTarget);
  preview.innerHTML = `<img alt="Signature ${sigTarget}" src="${dataURL}">`;
  closeSigModal();
});

/* Drawing (mouse + touch) with coordinate conversion */
function getPos(e){
  const rect = sigCanvas.getBoundingClientRect();
  if(e.touches && e.touches[0]){
    return { x: (e.touches[0].clientX - rect.left), y: (e.touches[0].clientY - rect.top) };
  }
  return { x: (e.clientX - rect.left), y: (e.clientY - rect.top) };
}
function startDraw(e){
  drawing = true;
  sigCtx.beginPath();
  const {x,y}=getPos(e);
  sigCtx.moveTo(x, y);
  e.preventDefault?.();
}
function endDraw(){ drawing = false; sigCtx.beginPath(); }
function moveDraw(e){
  if(!drawing) return;
  const {x,y} = getPos(e);
  sigCtx.lineTo(x, y);
  sigCtx.stroke();
  sigCtx.beginPath();
  sigCtx.moveTo(x, y);
  e.preventDefault?.();
}
sigCanvas.addEventListener("mousedown", startDraw);
sigCanvas.addEventListener("mousemove", moveDraw);
window.addEventListener("mouseup", endDraw);
sigCanvas.addEventListener("touchstart", startDraw, {passive:false});
sigCanvas.addEventListener("touchmove", moveDraw, {passive:false});
sigCanvas.addEventListener("touchend", endDraw);
window.addEventListener("resize", ()=> {
  // Only resize when modal is open to avoid reflow glitches
  if(sigModal.getAttribute("aria-hidden")==="false"){ 
    const img = new Image();
    img.onload = ()=>{
      resizeSigCanvas();
      sigCtx.drawImage(img, 0, 0, sigCanvas.width/scaleX, sigCanvas.height/scaleY);
    };
    img.src = sigCanvas.toDataURL("image/png");
  }
});

/* Clear preview buttons + restore previews on load */
$("clearPreviewOwner").addEventListener("click", ()=>{
  localStorage.removeItem("sig_owner");
  $("preview_owner").innerHTML = `<span>Tap to Sign (Owner)</span>`;
});
$("clearPreviewPayor").addEventListener("click", ()=>{
  localStorage.removeItem("sig_payor");
  $("preview_payor").innerHTML = `<span>Tap to Sign (Payor)</span>`;
});
window.addEventListener("DOMContentLoaded", ()=>{
  ["owner","payor"].forEach(role=>{
    const saved = localStorage.getItem("sig_"+role);
    if(saved){ $("preview_"+role).innerHTML = `<img alt="Signature ${role}" src="${saved}">`; }
  });
});

/* ---------- Restore on load ---------- */
(function restoreAll(){
  document.querySelectorAll("input,select,textarea").forEach(el=> {
    if(el.id !== "Onetimecharge_amt" && el.name !== "onetime_charge_option") {
      autoBindSave(el);
    }
  });
  restoreOneTimeState(); updateThirdPPUI(); updatePayorSectionUI();

  policiesContainer.innerHTML = ""; policyCount = 0;
  const savedCount = Math.max(1, Math.min(parseInt(localStorage.getItem("policyCount")) || 1, MAX_POLICIES));
  for(let i=1;i<=savedCount;i++){ addPolicy(); }

  const cn = $("CardName"); if(cn.value) cn.value = cn.value.toUpperCase();
})();

/* ---------- PDF helpers ---------- */
function writeCardToPdf(form){
  const digits = [ $("CardNo_1"), $("CardNo_2"), $("CardNo_3"), $("CardNo_4") ];
  const combined = digits.map(d => (d.value||"").padEnd(4,' ')).join('').slice(0,16);
  for(let i=0;i<16;i++){
    const field = `CardNo_${i+1}`;
    const ch = combined[i] && combined[i] !== ' ' ? combined[i] : "";
    safeSetText(form, field, ch);
  }
}
function applyRelationship(form, n){
  const dd = document.getElementById(`Relationship${n}`);
  const val = (dd && dd.value) ? dd.value : "";
  const map = { "OWNSELF":"Ownself","SPOUSE":"spouse","CHILDREN":"children","PARENT":"Parent","GRANDPARENT":"Grandparent","SIBLING":"Sibling","COMPANY":"Company" };
  const all = Object.values(map);
  all.forEach(name => safeCheck(form, `Relationship${n}_${name}`, false));
  if(val && map[val]) safeCheck(form, `Relationship${n}_${map[val]}`, true);
}

/* ---------- Generate PDF ---------- */
async function fillPDF(){
  try {
    $("generate").disabled = true;

    const res = await fetch(PDF_FILENAME);
    if (!res.ok) throw new Error("Cannot load PDF: " + PDF_FILENAME);
    const bytes = await res.arrayBuffer();
    const pdfDoc = await PDFLib.PDFDocument.load(bytes);
    const form = pdfDoc.getForm();

    // HEADER
    safeCheck(form, "CCAgree", $("CCAgree").checked);
    safeCheck(form, "Onetimecharge_tick", $("Onetimecharge_tick").checked);

    if ($("Onetimecharge_tick").checked) {
      if ($("Onetimecharge_alloutstanding").checked) {
        safeCheck(form, "Onetimecharge_alloutstanding", true);
        safeSetText(form, "Onetimecharge_amt", "");
      } else if ($("Onetimecharge_specific").checked) {
        safeCheck(form, "Onetimecharge_alloutstanding", false);
        safeSetText(form, "Onetimecharge_amt", $("Onetimecharge_amt").value || "");
      }
    } else {
      safeCheck(form, "Onetimecharge_alloutstanding", false);
      safeSetText(form, "Onetimecharge_amt", "");
    }

    // SECTION A
    const created = policiesContainer.querySelectorAll(".policy");
    created.forEach(p => {
      const idx = p.dataset.index;
      const policyVal = p.querySelector(`#PolicyNo${idx}`)?.value || "";
      const insuredVal = p.querySelector(`#Insured${idx}`)?.value || "";
      safeSetText(form, `PolicyNo${idx}`, policyVal);
      safeSetText(form, `Insured${idx}`, insuredVal);
      applyRelationship(form, idx);
    });

    // CARD DETAILS
    safeCheck(form, "CC_Tick", $("CC_Tick").checked);
    safeCheck(form, "DebitC_Tick", $("DebitC_Tick").checked);
    safeSetText(form, "CardName", $("CardName").value || "");
    writeCardToPdf(form);

    // Expiry split
    const mm = ($("CardExpry_M_Select").value || "").padStart(2,' ');
    const yy = ($("CardExpry_Y_Select").value || "").padStart(2,' ');
    safeSetText(form, "CardExpry_M1", mm[0] || "");
    safeSetText(form, "CardExpry_M2", mm[1] || "");
    safeSetText(form, "CardExpry_Y1", yy[0] || "");
    safeSetText(form, "CardExpry_Y2", yy[1] || "");

    safeSetText(form, "CardBank", $("CardBank_Select").value || "");

    // BRAND
    safeCheck(form, "Visa_Tick", $("Visa_Tick").checked);
    safeCheck(form, "Master_Tick", $("Master_Tick").checked);

    // SIGN META
    safeSetText(form, "Sign_OwnerName", $("Sign_OwnerName").value.toUpperCase() || "");
    safeSetText(form, "Sign_OwnerNIRC", $("Sign_OwnerNIRC").value || "");
    safeSetText(form, "Sign_State", $("Sign_State_Select").value || "");
    safeSetText(form, "Sign_Date", $("Sign_Date_Select").value || "");
    safeSetText(form, "Sign_Month", $("Sign_Month_Select").value || "");
    safeSetText(form, "Sign_Year", $("Sign_Year_Select").value || "");
    safeSetText(form, "Sign_PayorName", $("Sign_PayorName").value.toUpperCase() || "");
    safeSetText(form, "Sign_PayorNIRC", $("Sign_PayorNIRC").value || "");

    // THIRD PARTY SECTION
    safeCheck(form, "ThirdPP_Yes", $("ThirdPP_Yes").checked);
    safeCheck(form, "ThirdPP_SubmittedNRIC", $("ThirdPP_Yes").checked && $("ThirdPP_SubmittedNRIC").checked);
    if ($("ThirdPP_Yes").checked && $("ThirdPP_SubmittedNRIC").checked) {
      [
        "ThirdPP_Name","ThirdPP_NIRC","ThirdPP_Nationality","ThirdPP_CorrespAdd_Line1",
        "ThirdPP_CorrespAdd_Line2","ThirdPP_CorrrepAdd_Postcode","ThirdPP_CorrespAdd_Country",
        "ThirdPP_Email","ThirdPP_Phone","ThirdPP_Occupation","ThirdPP_Employer",
        "ThirdPP_NatureBusiness","ThirdPP_Income",
        "ThirdPP_SourceFund_Others_Write","ThirdPP_SourceWealth_Others_Write"
      ].forEach(id=> safeSetText(form, id, $(id).value || ""));
      safeSetText(form, "ThirdPP_DOB_DD", $("ThirdPP_DOB_DD").value || "");
      safeSetText(form, "ThirdPP_DOB_MM", $("ThirdPP_DOB_MM").value || "");
      safeSetText(form, "ThirdPP_DOB_YYYY", $("ThirdPP_DOB_YYYY").value || "");
      [
        "ThirdPP_SourceFund_Self","ThirdPP_SourceFund_Parent","ThirdPP_SourceFund_Spouse","ThirdPP_SourceFund_Others",
        "ThirdPP_SourceWealth_EmployBus","ThirdPP_SourceWealth_Invest","ThirdPP_SourceWealth_Inherit","ThirdPP_SourceWealth_Savings",
        "ThirdPP_SourceWealth_Parents","ThirdPP_SourceWealth_Spouse","ThirdPP_SourceWealth_Others"
      ].forEach(id=> safeCheck(form, id, $(id).checked));
    }

    // PDPA
    safeCheck(form, "PDPA", $("PDPA").checked);

    /* --------- SIGNATURE IMAGE EMBEDDING (embedPng + drawImage) --------- */
    const pages = pdfDoc.getPages();
    const pageIndex = Math.min(2, pages.length - 1); // Page 3 (index 2); adjust if needed
    const page = pages[pageIndex];

// Owner signature
const sigOwner = localStorage.getItem("sig_owner");
if (sigOwner) {
  try {
    const imgOwner = await pdfDoc.embedPng(sigOwner);
    const { width, height } = imgOwner.size();

    const previewEl = document.getElementById("preview_owner");
    const boxW = previewEl.offsetWidth;
    const boxH = previewEl.offsetHeight;

    const scale = Math.min(boxW / width, boxH / height);
    let drawW = width * scale;
    let drawH = height * scale;

    const factor = 0.40;    // 40% scale
    const posX = 50;         // X position on PDF
    const posY = 490;        // Y position on PDF

    drawW *= factor;
    drawH *= factor;

    page.drawImage(imgOwner, {
      x: posX,
      y: posY,
      width: drawW,
      height: drawH
    });
  } catch (e) {
    console.error(e);
  }
}

// Payor signature
const sigPayor = localStorage.getItem("sig_payor");
if (sigPayor) {
  try {
    const imgPayor = await pdfDoc.embedPng(sigPayor);
    const { width, height } = imgPayor.size();

    const previewEl = document.getElementById("preview_payor");
    const boxW = previewEl.offsetWidth;
    const boxH = previewEl.offsetHeight;

    const scale = Math.min(boxW / width, boxH / height);
    let drawW = width * scale;
    let drawH = height * scale;

    const factor = 0.40;    // 45% scale
    const posX = 370;         // X position on PDF
    const posY = 490;        // Y position on PDF

    drawW *= factor;
    drawH *= factor;

    page.drawImage(imgPayor, {
      x: posX,
      y: posY,
      width: drawW,
      height: drawH
    });
  } catch (e) {
    console.error(e);
  }
}
    
    // Flatten form fields before saving
    form.flatten();
    
    // Save & download
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "Filled_Credit_Card_Form.pdf"; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 2500);

  } catch(err){
    alert("PDF generation failed: " + (err.message || err));
    console.error(err);
  } finally {
    $("generate").disabled = false;
  }
}

/* ---------- Reset All ---------- */
function resetAll(){
  const keys = Object.keys(localStorage);
  keys.forEach(k=>{
    if(
      k.startsWith("PolicyNo") || k.startsWith("Insured") || k.startsWith("Relationship") ||
      ["policyCount","CCAgree","Onetimecharge_tick","onetime_charge_option",
       "CardName","CardNo_1","CardNo_2","CardNo_3","CardNo_4","CardExpry_M_Select","CardExpry_Y_Select","CardBank_Select",
       "CC_Tick","DebitC_Tick", "SameAsCardOwner", "Sign_OwnerName", "Sign_OwnerNIRC", "Sign_State_Select", "Sign_Date_Select", "Sign_Month_Select", "Sign_Year_Select",
       "ThirdPP_Yes","ThirdPP_SubmittedNRIC", "ThirdPP_Name","ThirdPP_NIRC", "ThirdPP_Nationality", "ThirdPP_CorrespAdd_Line1", "ThirdPP_CorrespAdd_Line2",
       "ThirdPP_CorrrepAdd_Postcode", "ThirdPP_CorrespAdd_Country", "ThirdPP_Email", "ThirdPP_Phone", "ThirdPP_Occupation", "ThirdPP_Employer",
       "ThirdPP_NatureBusiness", "ThirdPP_Income", "ThirdPP_DOB_DD", "ThirdPP_DOB_MM", "ThirdPP_DOB_YYYY",
       "ThirdPP_SourceFund_Self","ThirdPP_SourceFund_Parent","ThirdPP_SourceFund_Spouse","ThirdPP_SourceFund_Others","ThirdPP_SourceFund_Others_Write",
       "ThirdPP_SourceWealth_EmployBus","ThirdPP_SourceWealth_Invest","ThirdPP_SourceWealth_Inherit","ThirdPP_SourceWealth_Savings",
       "ThirdPP_SourceWealth_Parents","ThirdPP_SourceWealth_Spouse","ThirdPP_SourceWealth_Others","ThirdPP_SourceWealth_Others_Write",
       "Sign_PayorName", "Sign_PayorNIRC", "SameAsThirdPartyPayorName", "SameAsThirdPartyPayorNIRC",
       "PDPA",
       // signatures
       "sig_owner", "sig_payor"
      ].includes(k)
    ){
      localStorage.removeItem(k);
    }
  });

  document.querySelectorAll("input").forEach(inp=>{
    if (inp.type === "checkbox" || inp.type === "radio") inp.checked = false;
    else inp.value = "";
    if(inp.id === "Onetimecharge_amt") inp.disabled = true;
  });
  document.querySelectorAll("select").forEach(s=> s.selectedIndex = 0);

  // Clear signature previews
  $("preview_owner").innerHTML = `<span>Tap to Sign (Owner)</span>`;
  $("preview_payor").innerHTML = `<span>Tap to Sign (Payor)</span>`;

  // Rebuild policies
  policiesContainer.innerHTML = "";
  policyCount = 0;
  addPolicyBtn.disabled = false;
  addPolicy();

  updateOneTimeUI();
  updateThirdPPUI();
  updatePayorSectionUI();
  showSaveStatus();
}

/* ---------- Wire buttons ---------- */
$("generate").addEventListener("click", fillPDF);
$("resetAll").addEventListener("click", resetAll);
</script>
</body>
</html>
